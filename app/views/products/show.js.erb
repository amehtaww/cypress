<% if params[:task_ids] %>
  <% tasks_going_to_need_reloading = Task.where(:_id.in => params[:task_ids].split(",")) %>
  <% # itereate through any tasks that are still not ready %>
  <% tasks_going_to_need_reloading.each do |task| %>
    $("#<%= id_for_html_wrapper_of_task(task) %>").html("<%= escape_javascript render partial: '/products/product_test_link', locals: { test: task.product_test, task: task } %>");
  <% end %>

  <% tasks = tasks_needing_reload(@product) %>
  <% if tasks.any? %>
    <% task_ids = tasks.collect { |task| task.id.to_s }.join(',') %>
    setTimeout(function() {
      $.ajax({url: "<%= vendor_product_path(@product.vendor, @product) %>", type: "GET", dataType: 'script', data: { task_ids: "<%= task_ids %>" }});
    }, 500);
  <% else %>
    <% # reload the bulk download partial %>
    $('#display_bulk_download').html("<%= escape_javascript render partial: 'bulk_download', locals: { product: @product } %>");
  <% end %>
<% end %>
